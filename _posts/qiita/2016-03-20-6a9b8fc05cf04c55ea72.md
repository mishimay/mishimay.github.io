---
layout: post
title: "Swiftã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ã«é€å—ä¿¡ã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªEventHubã‚’æ›¸ãã¾ã—ãŸã€‚"
tags: Qiita
---

iOSã‚¢ãƒ—ãƒªã®é–‹ç™ºã§ã€ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ã£ãŸã‚Šãã‚Œã‚’å—ã‘å–ã£ãŸã‚Šã—ãŸã„å ´åˆã€é€šå¸¸NSNotificationCenterã‚’ä½¿ã†ã¨æ€ã„ã¾ã™ã€‚

ã—ã‹ã—ä½¿ã„å‹æ‰‹ãŒã‚ˆã„ã¨ã¯ã‚ã¾ã‚Šè¨€ãˆãªã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
ç†ç”±ã¨ã—ã¦ã¯...

- ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ã˜ã‚ƒãªã„
  - é€ã‚‹å´ã® `userInfo:` ã®ãƒ‡ãƒ¼ã‚¿ã®ç¨®é¡ã‚’å¤‰ãˆã¦ã‚‚å—ã‘å–ã‚‹å´ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„
- å¼•æ•°ãŒå¤šã„
  - `object:` ã£ã¦ä½•ï¼Ÿ é€ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡å®šã™ã‚‹ã‚“ã˜ã‚ƒãªã„ã®ï¼Ÿ
- åˆ©ç”¨ãŒçµ‚ã‚ã£ãŸã‚‰ `removeObserver:` ã—ãªã„ã¨ã„ã‘ãªã„
  - å¿˜ã‚ŒãŒã¡

ãªã®ã§ä¸Šè¨˜ã‚’è§£æ±ºã™ã‚‹ [EventHub](https://github.com/mishimay/EventHub) ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½œæˆã«ã‚ãŸã£ã¦ã“ã®è¨˜äº‹ã‚’å¤§ã„ã«å‚è€ƒã«ã•ã›ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚
[EventCenter: Androidã®EventBusã®Swiftç‰ˆã£ã½ã„ã®ã‚’ä½œã‚Šã¾ã—ãŸ - Qiita](http://qiita.com/mokemokechicken/items/64747d2b772a01835ac9)

ã¾ãŸã€ [SwiftEventBus](https://github.com/cesarferreira/SwiftEventBus)  ã‚„Androidã® [EventBus](https://github.com/greenrobot/EventBus) ã‹ã‚‰ã‚‚å½±éŸ¿ã‚’å—ã‘ã¦ã„ã¾ã™ã€‚

## ãƒªãƒã‚¸ãƒˆãƒª
https://github.com/mishimay/EventHub
å®Ÿä½“: https://github.com/mishimay/EventHub/blob/master/Pod/Classes/EventHub.swift
ãƒ†ã‚¹ãƒˆ: https://github.com/mishimay/EventHub/blob/master/Example/Tests/Tests.swift

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
CocoaPodsã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚

```ruby
use_frameworks!
pod "EventHub"
```

## ç’°å¢ƒ
Swift 2.1


# EventHubã®ç‰¹å¾´

- ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•
  - `EventType` ã¨ã„ã†ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’æº–æ‹ ã•ã›ãŸ `class`, `struct`, `enum` ã‚’é€å—ä¿¡ã™ã‚‹
  - ãã‚Œã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’æŒãŸã›ã‚Œã°ãƒ‡ãƒ¼ã‚¿ã®é€å—ä¿¡ã‚’ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ã«è¡Œã†ã“ã¨ãŒå¯èƒ½
- ç®¡ç†ãŒæ¥½
  - observerã§ã‚ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç ´æ£„ã•ã‚ŒãŸã‚‰EventHubã‹ã‚‰ã‚‚è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã‚‹
  - ã‚ˆã£ã¦ `removeObserver:` ãªã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶å¿…è¦ãŒãªã„
- è»½é‡
  - å®Ÿä½“ã¯Swiftãƒ•ã‚¡ã‚¤ãƒ«1ã¤ã ã‘


# ç°¡å˜ãªä¾‹
```swift
struct MessageEvent: EventType {
    let message: String
}

EventHub.addObserver(self) { (event: MessageEvent) in
    print(event.message) // -> ğŸ˜œ
}
EventHub.post(MessageEvent(message: "ğŸ˜œ"))
```

# ä½¿ã„æ–¹


1. **ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šç¾©**
  `EventType`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«æº–æ‹ ã•ã›ã¦ãã ã•ã„ã€‚
  `class` ã§ã‚‚ `struct` ã§ã‚‚ `enum` ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚
  ã“ã“ã§å®šç¾©ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’postã—ãŸã‚Šå—ã‘å–ã£ãŸã‚Šã—ã¾ã™ã€‚

    ```swift
    enum LoginEvent: EventType {
        case Success(id: String)
        case Failure(error: ErrorType)
    }
    ```

1. **observerã‚’è¿½åŠ **
  `addObserver(observer:thread:block:)` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³ã¾ã™ã€‚
  -  `observer`: ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚ã‚‚ã—ã“ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç ´æ£„ã•ã‚ŒãŸã‚‰EventHubã‹ã‚‰ã‚‚è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¦ `block:` ã§æ¸¡ã™å‡¦ç†ã‚‚å®Ÿè¡Œã•ã‚Œãªããªã‚Šã¾ã™ã€‚
  -  `thread`: æŒ‡å®šã¯ä»»æ„ã§ã™ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯nil)ã€‚ã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã‹æŒ‡å®šã—ã¾ã™ã€‚ã‚‚ã—nilã ã£ãŸå ´åˆã€å‡¦ç†ã¯ã‚¤ãƒ™ãƒ³ãƒˆãŒpostã•ã‚ŒãŸã‚¹ãƒ¬ãƒƒãƒ‰ã¨åŒã˜ã‚¹ãƒ¬ãƒƒãƒ‰ã§åŒæœŸçš„ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
  -  `block`: ã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã£ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã§ã™ã€‚postã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

    ```swift
    EventHub.addObserver(self, thread: .Main) { (event: LoginEvent) in
        switch event {
        case .Success(let id):
            print(id)
        case .Failure(let error):
            print(error)
        }
    }
    ```

1. **ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡**

    ```swift
    EventHub.post(LoginEvent.Success(id: id))
    ```

# ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜
å†…éƒ¨ã§ã¯NSNotificationCenterã‚’åˆ©ç”¨ã›ãšã€è‡ªå‰ã§é€å—ä¿¡ã®ä»•çµ„ã¿ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚

```swift
// EventTypeãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å®šç¾©ã§ã™ã€‚
// åˆ¶ç´„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
// EventTypeãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ç”¨æ„ã—ãŸç†ç”±ã¨ã—ã¦ã¯ã€ã‚‚ã—ã©ã‚“ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§postã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨
// ã€Œæ¸¡ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹ãŒåŒã˜ã ã‘ã©ã‚¤ãƒ™ãƒ³ãƒˆã®ç¨®é¡ãŒé•ã†ã€ã‚‚ã®ãŒã‚ã‚‹å ´åˆã«ãã‚Œã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒ
// åŒºåˆ¥ã—ã«ãããªã‚‹ã¨è€ƒãˆãŸã‹ã‚‰ã§ã™ã€‚
public protocol EventType {}

// ã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§observeã™ã‚‹ã‹ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã®enumã§ã™ã€‚
// .Backgroundã‚’æŒ‡å®šã™ã‚‹å ´åˆã€associated value ã«queueã‚’æŒ‡å®šã§ãã¾ã™ã€‚
// e.g. .Background(queue: dispatch_queue_create("com.example", nil))
public enum Thread {
    case Main
    case Background(queue: dispatch_queue_t?)

    private var queue: dispatch_queue_t {
        switch self {
        case .Main:
            return dispatch_get_main_queue()
        case .Background(let queue):
            return queue ?? dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0)
        }
    }
}

public struct EventHub {

    // ç™»éŒ²ã•ã‚ŒãŸobserveræƒ…å ±ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®structã§ã™ã€‚
    private struct Observation {
        weak var observer: AnyObject?
        let thread: Thread?
        let block: Any
    }

    // ç™»éŒ²ã•ã‚ŒãŸobserveræƒ…å ±ã‚’é…åˆ—ã§æŒã£ã¦ãŠãã¾ã™ã€‚
    private static var observations = [Observation]()

    // observerã®ç™»éŒ²
    public static func addObserver<T: EventType>(observer: AnyObject, thread: Thread? = nil, block: T -> ()) {
        observations.append(Observation(observer: observer, thread: thread, block: block))
    }

    // observerã®è§£é™¤
    // ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§observerã‚’è§£é™¤ã—ãŸã„å ´åˆã«ä½¿ç”¨ã—ã¾ã™ã€‚
    public static func removeObserver(observer: AnyObject) {
        observations = observations.filter { $0.observer! !== observer }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆã®é€ä¿¡
    public static func post<T: EventType>(event: T) {

        // ã¾ãšobserverãŒnilã«ãªã£ã¦ã„ã‚‹ (=ç ´æ£„ã•ã‚Œã¦ã„ã‚‹) ã‚‚ã®ã‚’å–ã‚Šé™¤ãã¾ã™ã€‚
        observations = observations.filter { $0.observer != nil }

        // ã‚¤ãƒ™ãƒ³ãƒˆã®å‹ãŒä¸€è‡´ã™ã‚‹blockã«å¯¾ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚
        observations.forEach {
            if let block = $0.block as? T -> () {

                // ã‚¹ãƒ¬ãƒƒãƒ‰æŒ‡å®šãŒã‚ã‚Œã°ãã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§éåŒæœŸçš„ã«ã€
                // ã‚¹ãƒ¬ãƒƒãƒ‰æŒ‡å®šãŒãªã‘ã‚Œã°åŒã˜ã‚¹ãƒ¬ãƒƒãƒ‰ã§åŒæœŸçš„ã«blockã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
                if let queue = $0.thread?.queue {
                    dispatch_async(queue) {
                        block(event)
                    }
                } else {
                    block(event)
                }
            }
        }
    }

}
```

# ãŠã‚ã‚Šã«

çµæ§‹ä¾¿åˆ©ãªã‚‚ã®ãŒã§ããŸã‚“ã˜ã‚ƒãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
æœ€åˆNSNotificationCenterã‚’ä½¿ã£ã¦ä½œã‚ã†ã¨æ€ã„ã¾ã—ãŸãŒã‚€ã—ã‚ä½¿ã‚ãªã„ã»ã†ãŒç°¡å˜ã«æ›¸ã‘ã¾ã—ãŸã€‚
ã“ã‚Œã‹ã‚‰ã©ã‚“ã©ã‚“ä½¿ã£ã¦ã„ããŸã„ã§ã™ã€‚

â€» *ã‚‚ã¨ã‚‚ã¨EventKitã¨ã„ã†åå‰ã§ã—ãŸãŒã€åŒåã®iOSã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒã‚ã£ãŸã®ã§EventHubã«å¤‰ãˆã¾ã—ãŸã€‚è©³ã—ãã¯ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚*


